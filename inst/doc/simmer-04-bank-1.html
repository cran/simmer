<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Duncan Garmonsway" />

<meta name="date" content="2024-07-04" />

<title>The Bank Tutorial: Part I</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">The Bank Tutorial: Part I</h1>
<h4 class="author">Duncan Garmonsway</h4>
<h4 class="date">2024-07-04</h4>


<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction">Introduction</a></li>
<li><a href="#a-single-customer" id="toc-a-single-customer">A single
customer</a>
<ul>
<li><a href="#a-customer-arriving-at-a-fixed-time" id="toc-a-customer-arriving-at-a-fixed-time">A customer arriving at a
fixed time</a></li>
<li><a href="#a-customer-arriving-at-random" id="toc-a-customer-arriving-at-random">A customer arriving at
random</a></li>
<li><a href="#more-customers" id="toc-more-customers">More
customers</a></li>
<li><a href="#many-customers" id="toc-many-customers">Many
customers</a></li>
<li><a href="#many-random-customers" id="toc-many-random-customers">Many
random customers</a></li>
</ul></li>
<li><a href="#a-service-counter" id="toc-a-service-counter">A Service
counter</a>
<ul>
<li><a href="#one-service-counter" id="toc-one-service-counter">One
Service counter</a></li>
<li><a href="#a-server-with-a-random-service-time" id="toc-a-server-with-a-random-service-time">A server with a random
service time</a></li>
</ul></li>
<li><a href="#several-service-counters" id="toc-several-service-counters">Several Service Counters</a>
<ul>
<li><a href="#several-counters-but-a-single-queue" id="toc-several-counters-but-a-single-queue">Several Counters but a
Single Queue</a></li>
<li><a href="#several-counters-with-individual-queues" id="toc-several-counters-with-individual-queues">Several Counters with
individual queues</a></li>
<li><a href="#the-bank-with-a-monitor-aka-summary-statistics" id="toc-the-bank-with-a-monitor-aka-summary-statistics">The bank with a
monitor (aka summary statistics)</a></li>
<li><a href="#multiple-runs" id="toc-multiple-runs">Multiple
runs</a></li>
</ul></li>
</ul>
</div>

<div id="introduction" class="section level2">
<h2>Introduction</h2>
<p>This tutorial is adapted from a tutorial for the Python 2 package
‘SimPy’, <a href="https://pythonhosted.org/SimPy/Tutorials/TheBank.html">here</a>.
Users familiar with SimPy may find this tutorial helpful for
transitioning to <code>simmer</code>.</p>
</div>
<div id="a-single-customer" class="section level2">
<h2>A single customer</h2>
<p>In this tutorial we model a simple bank with customers arriving at
random. We develop the model step-by-step, starting out simply, and
producing a running program at each stage.</p>
<p>A simulation should always be developed to answer a specific
question; in these models we investigate how changing the number of bank
servers or tellers might affect the waiting time for customers.</p>
<div id="a-customer-arriving-at-a-fixed-time" class="section level3">
<h3>A customer arriving at a fixed time</h3>
<p>We first model a single customer who arrives at the bank for a visit,
looks around at the decor for a time and then leaves. There is no
queueing. First we will assume his arrival time and the time he spends
in the bank are fixed.</p>
<p>The arrival time is fixed at 5, and the time spent in the bank is
fixed at 10. We interpret ‘5’ and ‘10’ as ‘5 minutes’ and ‘10 minutes’.
The simulation runs for a maximum of 100 minutes, or until all the
customers that are generated complete their trajectories.</p>
<p>Note where these constants appear in the code below.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;I must leave&quot;</span>)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a></span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="fu">at</span>(<span class="dv">5</span>))</span>
<span id="cb1-12"><a href="#cb1-12" tabindex="-1"></a></span>
<span id="cb1-13"><a href="#cb1-13" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">100</span>)</span>
<span id="cb1-14"><a href="#cb1-14" tabindex="-1"></a><span class="co">#&gt; 5: Customer0: Here I am</span></span>
<span id="cb1-15"><a href="#cb1-15" tabindex="-1"></a><span class="co">#&gt; 15: Customer0: I must leave</span></span>
<span id="cb1-16"><a href="#cb1-16" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 15 | next: </span></span>
<span id="cb1-17"><a href="#cb1-17" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb1-18"><a href="#cb1-18" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 1 }</span></span></code></pre></div>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">get_mon_arrivals</span>()</span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a><span class="co">#&gt;        name start_time end_time activity_time finished replication</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a><span class="co">#&gt; 1 Customer0          5       15            10     TRUE           1</span></span></code></pre></div>
<p>The short trace printed out by the <code>get_mon_arrivals</code>
function shows the result. The program finishes at simulation time 15
because there are no further events to be executed. At the end of the
visit, the customer has no more actions and no other objects or
customers are active.</p>
</div>
<div id="a-customer-arriving-at-random" class="section level3">
<h3>A customer arriving at random</h3>
<p>Now we extend the model to allow our customer to arrive at a random
simulated time though we will keep the time in the bank at 10, as
before.</p>
<p>The change occurs in the arguments to the <code>add_generator</code>
function. The function <code>rexp</code> draws from an exponential
distribution with the given parameter, which in this case is
<code>1/5</code>. See <code>?rexp</code> for more details. We also seed
the random number generator with 10211 so that the same sequence of
random numbers will be drawn every time the script is run.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">10212</span>)</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a></span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-7"><a href="#cb3-7" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-8"><a href="#cb3-8" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-9"><a href="#cb3-9" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;I must leave&quot;</span>)</span>
<span id="cb3-10"><a href="#cb3-10" tabindex="-1"></a></span>
<span id="cb3-11"><a href="#cb3-11" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb3-12"><a href="#cb3-12" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-13"><a href="#cb3-13" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="fu">at</span>(<span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">5</span>)))</span>
<span id="cb3-14"><a href="#cb3-14" tabindex="-1"></a></span>
<span id="cb3-15"><a href="#cb3-15" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">100</span>)</span>
<span id="cb3-16"><a href="#cb3-16" tabindex="-1"></a><span class="co">#&gt; 7.8393: Customer0: Here I am</span></span>
<span id="cb3-17"><a href="#cb3-17" tabindex="-1"></a><span class="co">#&gt; 17.8393: Customer0: I must leave</span></span>
<span id="cb3-18"><a href="#cb3-18" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 17.8393046225526 | next: </span></span>
<span id="cb3-19"><a href="#cb3-19" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb3-20"><a href="#cb3-20" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 1 }</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">get_mon_arrivals</span>()</span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a><span class="co">#&gt;        name start_time end_time activity_time finished replication</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a><span class="co">#&gt; 1 Customer0   7.839305  17.8393            10     TRUE           1</span></span></code></pre></div>
<p>The trace shows that the customer now arrives at time 7.839305.
Changing the seed value would change that time.</p>
</div>
<div id="more-customers" class="section level3">
<h3>More customers</h3>
<p>Our simulation does little so far. To consider a simulation with
several customers we return to the simple deterministic model and add
more customers.</p>
<p>The program is almost as easy as the first example (A customer
arriving at a fixed time). The main change is in the
<code>add_generator</code> function, where we generate three customers
by defining three start times. We also increase the maximum simulation
time to 400 in the <code>run</code> function. Observe that we need only
one definition of the customer trajectory, and generate several
customers who follow that trajectory. These customers act quite
independently in this model.</p>
<p>Each customer also stays in the bank for a different, but non-random,
amount of time. This is an unusual case, so it requires an unusual bit
of R code. The <code>timeout</code> function accepts either a constant
waiting time, or a function that is called once per customer and returns
a single value (e.g. <code>rexp(1, 1/10)</code>). So we need to create a
function that returns a different, but specific, value each time it is
called. We define a function called <code>loop</code> to do this. The
<code>loop</code> function returns another function. In the example, we
store that function under the name <code>x</code>. When called, the
function <code>x</code> returns one of (in the example) 7, 10, and 20,
in sequence, wrapping around when it is called a fourth time.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># Function to specify a series of waiting times, that loop around</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>loop <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>    time_diffs <span class="ot">&lt;-</span> <span class="fu">c</span>(...)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>    <span class="cf">function</span>() {</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> <span class="fu">length</span>(time_diffs)) {</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>        i <span class="ot">&lt;&lt;-</span> i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>        i <span class="ot">&lt;&lt;-</span> <span class="dv">1</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>      }</span>
<span id="cb5-11"><a href="#cb5-11" tabindex="-1"></a>      <span class="fu">return</span>(time_diffs[i])</span>
<span id="cb5-12"><a href="#cb5-12" tabindex="-1"></a>    }</span>
<span id="cb5-13"><a href="#cb5-13" tabindex="-1"></a>  }</span>
<span id="cb5-14"><a href="#cb5-14" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">loop</span>(<span class="dv">10</span>, <span class="dv">7</span>, <span class="dv">20</span>)</span>
<span id="cb5-16"><a href="#cb5-16" tabindex="-1"></a><span class="fu">x</span>(); <span class="fu">x</span>(); <span class="fu">x</span>(); <span class="fu">x</span>(); <span class="fu">x</span>()</span>
<span id="cb5-17"><a href="#cb5-17" tabindex="-1"></a><span class="co">#&gt; [1] 10</span></span>
<span id="cb5-18"><a href="#cb5-18" tabindex="-1"></a><span class="co">#&gt; [1] 7</span></span>
<span id="cb5-19"><a href="#cb5-19" tabindex="-1"></a><span class="co">#&gt; [1] 20</span></span>
<span id="cb5-20"><a href="#cb5-20" tabindex="-1"></a><span class="co">#&gt; [1] 10</span></span>
<span id="cb5-21"><a href="#cb5-21" tabindex="-1"></a><span class="co">#&gt; [1] 7</span></span></code></pre></div>
<p>The technical term for the <code>loop</code> function is a ‘closure’.
How closures work is beyond the scope of this vignette; if you wish to
learn more, then <a href="http://adv-r.had.co.nz/Functional-programming.html#closures">Advanced
R</a> by Hadley Wickam has a good explanation.</p>
<p>When we use <code>loop</code> in the <code>timeout</code> function,
we don’t need to assign its output to a name; it can be an ‘anonymous’
function. It will be called whenever a customer is about to wait and
needs to know how long to wait for. Because only three customers are
generated, and their first step is the timeout step, they are assigned
7, 10, and 20 in order.</p>
<p>Note that this code differs from the SimPy in the order that
customers are defined. Here, the first customer to be defined is the one
who arrives at 2 and waits for 7. That is because the arguments to
<code>at()</code> must be in ascending order.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="co"># Function to specify a series of waiting times in a loop</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>loop <span class="ot">&lt;-</span> <span class="cf">function</span>(...) {</span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>    time_diffs <span class="ot">&lt;-</span> <span class="fu">c</span>(...)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>    i <span class="ot">&lt;-</span> <span class="dv">0</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>    <span class="cf">function</span>() {</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>      <span class="cf">if</span> (i <span class="sc">&lt;</span> <span class="fu">length</span>(time_diffs)) {</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>        i <span class="ot">&lt;&lt;-</span> i<span class="sc">+</span><span class="dv">1</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>      } <span class="cf">else</span> {</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>        i <span class="ot">&lt;&lt;-</span> <span class="dv">1</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>      }</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>      <span class="fu">return</span>(time_diffs[i])</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    }</span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>  }</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="fu">loop</span>(<span class="dv">7</span>, <span class="dv">10</span>, <span class="dv">20</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;I must leave&quot;</span>)</span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a></span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="fu">at</span>(<span class="dv">2</span>, <span class="dv">5</span>, <span class="dv">12</span>))</span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a></span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a><span class="co">#&gt; 2: Customer0: Here I am</span></span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a><span class="co">#&gt; 5: Customer1: Here I am</span></span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a><span class="co">#&gt; 9: Customer0: I must leave</span></span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a><span class="co">#&gt; 12: Customer2: Here I am</span></span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a><span class="co">#&gt; 15: Customer1: I must leave</span></span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a><span class="co">#&gt; 32: Customer2: I must leave</span></span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 32 | next: </span></span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 3 }</span></span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">get_mon_arrivals</span>()</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="co">#&gt;        name start_time end_time activity_time finished replication</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="co">#&gt; 1 Customer0          2        9             7     TRUE           1</span></span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="co">#&gt; 2 Customer1          5       15            10     TRUE           1</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a><span class="co">#&gt; 3 Customer2         12       32            20     TRUE           1</span></span></code></pre></div>
<p>Alternatively, we can create three different customer trajectories
for the three waiting times. This is best done by creating an initial
template, and then modifying the waiting time for each copy.</p>
<p>Note that the order in which the customers are defined does not
matter this time, and we can also name each customer.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a><span class="co"># Create a template trajectory</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="dv">1</span>) <span class="sc">%&gt;%</span> <span class="co"># The timeout of 1 is a placeholder to be overwritten later</span></span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;I must leave&quot;</span>)</span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a><span class="co"># Create three copies of the template</span></span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>Klaus <span class="ot">&lt;-</span> customer</span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>Tony <span class="ot">&lt;-</span> customer</span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>Evelyn <span class="ot">&lt;-</span> customer</span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a></span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a><span class="co"># Modify the timeout of each copy</span></span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>Klaus[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">timeout</span>(<span class="fu">trajectory</span>(), <span class="dv">10</span>)</span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>Tony[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">timeout</span>(<span class="fu">trajectory</span>(), <span class="dv">7</span>)</span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>Evelyn[<span class="dv">2</span>] <span class="ot">&lt;-</span> <span class="fu">timeout</span>(<span class="fu">trajectory</span>(), <span class="dv">20</span>)</span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a><span class="co"># Check that the modifications worked</span></span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>Klaus</span>
<span id="cb8-22"><a href="#cb8-22" tabindex="-1"></a><span class="co">#&gt; trajectory: Customer&#39;s path, 3 activities</span></span>
<span id="cb8-23"><a href="#cb8-23" tabindex="-1"></a><span class="co">#&gt; { Activity: Log          | message: Here I am, level: 0 }</span></span>
<span id="cb8-24"><a href="#cb8-24" tabindex="-1"></a><span class="co">#&gt; { Activity: Timeout      | delay: 10 }</span></span>
<span id="cb8-25"><a href="#cb8-25" tabindex="-1"></a><span class="co">#&gt; { Activity: Log          | message: I must lea..., level: 0 }</span></span></code></pre></div>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>Tony</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="co">#&gt; trajectory: Customer&#39;s path, 3 activities</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a><span class="co">#&gt; { Activity: Log          | message: Here I am, level: 0 }</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a><span class="co">#&gt; { Activity: Timeout      | delay: 7 }</span></span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a><span class="co">#&gt; { Activity: Log          | message: I must lea..., level: 0 }</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>Evelyn</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a><span class="co">#&gt; trajectory: Customer&#39;s path, 3 activities</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a><span class="co">#&gt; { Activity: Log          | message: Here I am, level: 0 }</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a><span class="co">#&gt; { Activity: Timeout      | delay: 20 }</span></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="co">#&gt; { Activity: Log          | message: I must lea..., level: 0 }</span></span></code></pre></div>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Klaus&quot;</span>, Klaus, <span class="fu">at</span>(<span class="dv">5</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Tony&quot;</span>, Tony, <span class="fu">at</span>(<span class="dv">2</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Evelyn&quot;</span>, Evelyn, <span class="fu">at</span>(<span class="dv">12</span>))</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a></span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a><span class="co">#&gt; 2: Tony0: Here I am</span></span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a><span class="co">#&gt; 5: Klaus0: Here I am</span></span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a><span class="co">#&gt; 9: Tony0: I must leave</span></span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a><span class="co">#&gt; 12: Evelyn0: Here I am</span></span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a><span class="co">#&gt; 15: Klaus0: I must leave</span></span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a><span class="co">#&gt; 32: Evelyn0: I must leave</span></span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 32 | next: </span></span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a><span class="co">#&gt; { Source: Klaus | monitored: 1 | n_generated: 1 }</span></span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a><span class="co">#&gt; { Source: Tony | monitored: 1 | n_generated: 1 }</span></span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a><span class="co">#&gt; { Source: Evelyn | monitored: 1 | n_generated: 1 }</span></span></code></pre></div>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">get_mon_arrivals</span>()</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a><span class="co">#&gt;      name start_time end_time activity_time finished replication</span></span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a><span class="co">#&gt; 1   Tony0          2        9             7     TRUE           1</span></span>
<span id="cb12-4"><a href="#cb12-4" tabindex="-1"></a><span class="co">#&gt; 2  Klaus0          5       15            10     TRUE           1</span></span>
<span id="cb12-5"><a href="#cb12-5" tabindex="-1"></a><span class="co">#&gt; 3 Evelyn0         12       32            20     TRUE           1</span></span></code></pre></div>
<p>Again, the simulations finish before the 400 specified in the
<code>run</code> function.</p>
</div>
<div id="many-customers" class="section level3">
<h3>Many customers</h3>
<p>Another change will allow us to have more customers. To make things
clearer we do not use random numbers in this model.</p>
<p>The change is in the <code>add_generator</code> function, where we
use a convenience function <code>from_to</code> to create a sequence of
start times for five customers, starting at time 0, with an interarrival
time of 10 between each customer. One idiosyncracy of the syntax is that
no arrival is created on the <code>to</code> time, so we give it as 41,
one unit after the last arrival to be generated. Another is that the
interarrival time must be specified as a function, hence we define a
constant function <code>function() {10}</code></p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="dv">12</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;I must leave&quot;</span>)</span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="fu">from_to</span>(<span class="dv">0</span>, <span class="dv">41</span>, <span class="cf">function</span>() {<span class="dv">10</span>}))</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Here I am</span></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="co">#&gt; 10: Customer1: Here I am</span></span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a><span class="co">#&gt; 12: Customer0: I must leave</span></span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a><span class="co">#&gt; 20: Customer2: Here I am</span></span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a><span class="co">#&gt; 22: Customer1: I must leave</span></span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a><span class="co">#&gt; 30: Customer3: Here I am</span></span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a><span class="co">#&gt; 32: Customer2: I must leave</span></span>
<span id="cb13-21"><a href="#cb13-21" tabindex="-1"></a><span class="co">#&gt; 40: Customer4: Here I am</span></span>
<span id="cb13-22"><a href="#cb13-22" tabindex="-1"></a><span class="co">#&gt; 42: Customer3: I must leave</span></span>
<span id="cb13-23"><a href="#cb13-23" tabindex="-1"></a><span class="co">#&gt; 52: Customer4: I must leave</span></span>
<span id="cb13-24"><a href="#cb13-24" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 52 | next: </span></span>
<span id="cb13-25"><a href="#cb13-25" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb13-26"><a href="#cb13-26" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 5 }</span></span></code></pre></div>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">get_mon_arrivals</span>()</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="co">#&gt;        name start_time end_time activity_time finished replication</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="co">#&gt; 1 Customer0          0       12            12     TRUE           1</span></span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a><span class="co">#&gt; 2 Customer1         10       22            12     TRUE           1</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a><span class="co">#&gt; 3 Customer2         20       32            12     TRUE           1</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a><span class="co">#&gt; 4 Customer3         30       42            12     TRUE           1</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a><span class="co">#&gt; 5 Customer4         40       52            12     TRUE           1</span></span></code></pre></div>
</div>
<div id="many-random-customers" class="section level3">
<h3>Many random customers</h3>
<p>We now extend this model to allow arrivals at random. In simulation
this is usually interpreted as meaning that the times between customer
arrivals are distributed as exponential random variates. There is little
change in our program. The only difference between this and the previous
example of a single customer generated at a random time is that this
example generates several customers at different random times.</p>
<p>The change occurs in the arguments to the <code>add_generator</code>
function. The function <code>rexp</code> draws from an exponential
distribution with the given parameter, which in this case is
<code>1/10</code>. See <code>?rexp</code> for more details. We also seed
the random number generator with 1289 so that the same sequence of
random numbers will be drawn every time the script is run. The 0 is the
time of the first customer, then four random interarrival times are
drawn, and a final -1 stops the generator.</p>
<p>The reason why we cannot use the <code>from_to</code> function here
is that we want to control the number of arrivals that are generated,
rather than the end-time of arrival generation.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1289</span>)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="dv">12</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;I must leave&quot;</span>)</span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a></span>
<span id="cb15-11"><a href="#cb15-11" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb15-12"><a href="#cb15-12" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb15-13"><a href="#cb15-13" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="cf">function</span>() {<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>), <span class="sc">-</span><span class="dv">1</span>)})</span>
<span id="cb15-14"><a href="#cb15-14" tabindex="-1"></a></span>
<span id="cb15-15"><a href="#cb15-15" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb15-16"><a href="#cb15-16" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Here I am</span></span>
<span id="cb15-17"><a href="#cb15-17" tabindex="-1"></a><span class="co">#&gt; 12: Customer0: I must leave</span></span>
<span id="cb15-18"><a href="#cb15-18" tabindex="-1"></a><span class="co">#&gt; 14.3114: Customer1: Here I am</span></span>
<span id="cb15-19"><a href="#cb15-19" tabindex="-1"></a><span class="co">#&gt; 26.3114: Customer1: I must leave</span></span>
<span id="cb15-20"><a href="#cb15-20" tabindex="-1"></a><span class="co">#&gt; 26.5588: Customer2: Here I am</span></span>
<span id="cb15-21"><a href="#cb15-21" tabindex="-1"></a><span class="co">#&gt; 35.8506: Customer3: Here I am</span></span>
<span id="cb15-22"><a href="#cb15-22" tabindex="-1"></a><span class="co">#&gt; 38.2706: Customer4: Here I am</span></span>
<span id="cb15-23"><a href="#cb15-23" tabindex="-1"></a><span class="co">#&gt; 38.5588: Customer2: I must leave</span></span>
<span id="cb15-24"><a href="#cb15-24" tabindex="-1"></a><span class="co">#&gt; 47.8506: Customer3: I must leave</span></span>
<span id="cb15-25"><a href="#cb15-25" tabindex="-1"></a><span class="co">#&gt; 50.2706: Customer4: I must leave</span></span>
<span id="cb15-26"><a href="#cb15-26" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 50.2705868901582 | next: </span></span>
<span id="cb15-27"><a href="#cb15-27" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb15-28"><a href="#cb15-28" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 5 }</span></span></code></pre></div>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">get_mon_arrivals</span>()</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="co">#&gt;        name start_time end_time activity_time finished replication</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="co">#&gt; 1 Customer0    0.00000 12.00000            12     TRUE           1</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a><span class="co">#&gt; 2 Customer1   14.31136 26.31136            12     TRUE           1</span></span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a><span class="co">#&gt; 3 Customer2   26.55882 38.55882            12     TRUE           1</span></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="co">#&gt; 4 Customer3   35.85064 47.85064            12     TRUE           1</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a><span class="co">#&gt; 5 Customer4   38.27059 50.27059            12     TRUE           1</span></span></code></pre></div>
</div>
</div>
<div id="a-service-counter" class="section level2">
<h2>A Service counter</h2>
<p>So far, the model has been more like an art gallery, the customers
entering, looking around, and leaving. Now they are going to require
service from the bank clerk. We extend the model to include a service
counter that will be modelled as a ‘resource’. The actions of a Resource
are simple: a customer requests a unit of the resource (a clerk). If one
is free, then the customer gets service (and the unit is no longer
available to other customers). If there is no free clerk, then the
customer joins the queue (managed by the resource object) until it is
the customer’s turn to be served. As each customer completes service and
releases the unit, the clerk can start serving the next in line.</p>
<div id="one-service-counter" class="section level3">
<h3>One Service counter</h3>
<p>The service counter is created with the <code>add_resource</code>
function. Default arguments specify that it can serve one customer at a
time, and has infinite queueing capacity.</p>
<p>The <code>seize</code> function causes the customer to join the queue
at the counter. If the queue is empty and the counter is available (not
serving any customers), then the customer claims the counter for itself
and moves onto the <code>timeout</code> step. Otherwise the customer
must wait until the counter becomes available. Behaviour of the customer
while in the queue is controlled by the arguments of the
<code>seize</code> function, rather than by any other functions. Once
the <code>timeout</code> step is complete, the <code>release</code>
function causes the customer to make the counter available to other
customers in the queue.</p>
<p>Since the activity trace does not produce the waiting time by
default, this is calculated and appended using the
<code>transform</code> function.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1234</span>)</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>bank <span class="ot">&lt;-</span> <span class="fu">simmer</span>()</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="st">&quot;start_time&quot;</span>, <span class="cf">function</span>() {<span class="fu">now</span>(bank)}) <span class="sc">%&gt;%</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>  <span class="fu">seize</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Waited: &quot;</span>, <span class="fu">now</span>(bank) <span class="sc">-</span> <span class="fu">get_attribute</span>(bank, <span class="st">&quot;start_time&quot;</span>))}) <span class="sc">%&gt;%</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="dv">12</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>  <span class="fu">release</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Finished: &quot;</span>, <span class="fu">now</span>(bank))})</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>  <span class="fu">add_resource</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="cf">function</span>() {<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>), <span class="sc">-</span><span class="dv">1</span>)})</span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Here I am</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Waited:  0</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a><span class="co">#&gt; 12: Customer0: Finished:  12</span></span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a><span class="co">#&gt; 25.0176: Customer1: Here I am</span></span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a><span class="co">#&gt; 25.0176: Customer1: Waited:  0</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a><span class="co">#&gt; 27.4852: Customer2: Here I am</span></span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a><span class="co">#&gt; 27.551: Customer3: Here I am</span></span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a><span class="co">#&gt; 37.0176: Customer1: Finished:  37.0175860496223</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a><span class="co">#&gt; 37.0176: Customer2: Waited:  9.53241116646677</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a><span class="co">#&gt; 44.9785: Customer4: Here I am</span></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a><span class="co">#&gt; 49.0176: Customer2: Finished:  49.0175860496223</span></span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a><span class="co">#&gt; 49.0176: Customer3: Waited:  21.466591599012</span></span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a><span class="co">#&gt; 61.0176: Customer3: Finished:  61.0175860496223</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a><span class="co">#&gt; 61.0176: Customer4: Waited:  16.0391307005949</span></span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a><span class="co">#&gt; 73.0176: Customer4: Finished:  73.0175860496223</span></span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 73.0175860496223 | next: </span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a><span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span></span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 5 }</span></span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  <span class="fu">get_mon_arrivals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  <span class="fu">transform</span>(<span class="at">waiting_time =</span> end_time <span class="sc">-</span> start_time <span class="sc">-</span> activity_time)</span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a><span class="co">#&gt;        name start_time end_time activity_time finished replication waiting_time</span></span>
<span id="cb18-5"><a href="#cb18-5" tabindex="-1"></a><span class="co">#&gt; 1 Customer0    0.00000 12.00000            12     TRUE           1     0.000000</span></span>
<span id="cb18-6"><a href="#cb18-6" tabindex="-1"></a><span class="co">#&gt; 2 Customer1   25.01759 37.01759            12     TRUE           1     0.000000</span></span>
<span id="cb18-7"><a href="#cb18-7" tabindex="-1"></a><span class="co">#&gt; 3 Customer2   27.48517 49.01759            12     TRUE           1     9.532411</span></span>
<span id="cb18-8"><a href="#cb18-8" tabindex="-1"></a><span class="co">#&gt; 4 Customer3   27.55099 61.01759            12     TRUE           1    21.466592</span></span>
<span id="cb18-9"><a href="#cb18-9" tabindex="-1"></a><span class="co">#&gt; 5 Customer4   44.97846 73.01759            12     TRUE           1    16.039131</span></span></code></pre></div>
<p>Examining the trace we see that the first two customers get instant
service but the others have to wait. We still only have five customers,
so we cannot draw general conclusions.</p>
</div>
<div id="a-server-with-a-random-service-time" class="section level3">
<h3>A server with a random service time</h3>
<p>This is a simple change to the model in that we retain the single
service counter but make the customer service time a random variable. As
is traditional in the study of simple queues we first assume an
exponential service time.</p>
<p>Note that the argument to <code>timeout</code> must be a function,
otherwise it would apply a constant timeout to every customer.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a></span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1269</span>)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="st">&quot;start_time&quot;</span>, <span class="cf">function</span>() {<span class="fu">now</span>(bank)}) <span class="sc">%&gt;%</span></span>
<span id="cb19-9"><a href="#cb19-9" tabindex="-1"></a>  <span class="fu">seize</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-10"><a href="#cb19-10" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Waited: &quot;</span>, <span class="fu">now</span>(bank) <span class="sc">-</span> <span class="fu">get_attribute</span>(bank, <span class="st">&quot;start_time&quot;</span>))}) <span class="sc">%&gt;%</span></span>
<span id="cb19-11"><a href="#cb19-11" tabindex="-1"></a>  <span class="co"># timeout(rexp(1, 1/12)) would generate a single random time and use it for</span></span>
<span id="cb19-12"><a href="#cb19-12" tabindex="-1"></a>  <span class="co"># every arrival, whereas the following line generates a random time for each</span></span>
<span id="cb19-13"><a href="#cb19-13" tabindex="-1"></a>  <span class="co"># arrival</span></span>
<span id="cb19-14"><a href="#cb19-14" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="cf">function</span>() {<span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>)}) <span class="sc">%&gt;%</span></span>
<span id="cb19-15"><a href="#cb19-15" tabindex="-1"></a>  <span class="fu">release</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-16"><a href="#cb19-16" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Finished: &quot;</span>, <span class="fu">now</span>(bank))})</span>
<span id="cb19-17"><a href="#cb19-17" tabindex="-1"></a></span>
<span id="cb19-18"><a href="#cb19-18" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb19-19"><a href="#cb19-19" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-20"><a href="#cb19-20" tabindex="-1"></a>  <span class="fu">add_resource</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb19-21"><a href="#cb19-21" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="cf">function</span>() {<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>), <span class="sc">-</span><span class="dv">1</span>)})</span>
<span id="cb19-22"><a href="#cb19-22" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb19-24"><a href="#cb19-24" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Here I am</span></span>
<span id="cb19-25"><a href="#cb19-25" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Waited:  0</span></span>
<span id="cb19-26"><a href="#cb19-26" tabindex="-1"></a><span class="co">#&gt; 3.68365: Customer1: Here I am</span></span>
<span id="cb19-27"><a href="#cb19-27" tabindex="-1"></a><span class="co">#&gt; 3.89529: Customer2: Here I am</span></span>
<span id="cb19-28"><a href="#cb19-28" tabindex="-1"></a><span class="co">#&gt; 4.91521: Customer0: Finished:  4.91521483175031</span></span>
<span id="cb19-29"><a href="#cb19-29" tabindex="-1"></a><span class="co">#&gt; 4.91521: Customer1: Waited:  1.23156707156024</span></span>
<span id="cb19-30"><a href="#cb19-30" tabindex="-1"></a><span class="co">#&gt; 10.961: Customer3: Here I am</span></span>
<span id="cb19-31"><a href="#cb19-31" tabindex="-1"></a><span class="co">#&gt; 12.4143: Customer4: Here I am</span></span>
<span id="cb19-32"><a href="#cb19-32" tabindex="-1"></a><span class="co">#&gt; 21.0552: Customer1: Finished:  21.055182798071</span></span>
<span id="cb19-33"><a href="#cb19-33" tabindex="-1"></a><span class="co">#&gt; 21.0552: Customer2: Waited:  17.1598927142276</span></span>
<span id="cb19-34"><a href="#cb19-34" tabindex="-1"></a><span class="co">#&gt; 65.3116: Customer2: Finished:  65.3115507844349</span></span>
<span id="cb19-35"><a href="#cb19-35" tabindex="-1"></a><span class="co">#&gt; 65.3116: Customer3: Waited:  54.3505873236467</span></span>
<span id="cb19-36"><a href="#cb19-36" tabindex="-1"></a><span class="co">#&gt; 80.1134: Customer3: Finished:  80.1133545241526</span></span>
<span id="cb19-37"><a href="#cb19-37" tabindex="-1"></a><span class="co">#&gt; 80.1134: Customer4: Waited:  67.6990166719428</span></span>
<span id="cb19-38"><a href="#cb19-38" tabindex="-1"></a><span class="co">#&gt; 93.7286: Customer4: Finished:  93.7285504163997</span></span>
<span id="cb19-39"><a href="#cb19-39" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 93.7285504163997 | next: </span></span>
<span id="cb19-40"><a href="#cb19-40" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb19-41"><a href="#cb19-41" tabindex="-1"></a><span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span></span>
<span id="cb19-42"><a href="#cb19-42" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 5 }</span></span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>  <span class="fu">get_mon_arrivals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>  <span class="fu">transform</span>(<span class="at">waiting_time =</span> end_time <span class="sc">-</span> start_time <span class="sc">-</span> activity_time)</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a><span class="co">#&gt;        name start_time  end_time activity_time finished replication</span></span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a><span class="co">#&gt; 1 Customer0   0.000000  4.915215      4.915215     TRUE           1</span></span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="co">#&gt; 2 Customer1   3.683648 21.055183     16.139968     TRUE           1</span></span>
<span id="cb20-7"><a href="#cb20-7" tabindex="-1"></a><span class="co">#&gt; 3 Customer2   3.895290 65.311551     44.256368     TRUE           1</span></span>
<span id="cb20-8"><a href="#cb20-8" tabindex="-1"></a><span class="co">#&gt; 4 Customer3  10.960963 80.113355     14.801804     TRUE           1</span></span>
<span id="cb20-9"><a href="#cb20-9" tabindex="-1"></a><span class="co">#&gt; 5 Customer4  12.414338 93.728550     13.615196     TRUE           1</span></span>
<span id="cb20-10"><a href="#cb20-10" tabindex="-1"></a><span class="co">#&gt;   waiting_time</span></span>
<span id="cb20-11"><a href="#cb20-11" tabindex="-1"></a><span class="co">#&gt; 1     0.000000</span></span>
<span id="cb20-12"><a href="#cb20-12" tabindex="-1"></a><span class="co">#&gt; 2     1.231567</span></span>
<span id="cb20-13"><a href="#cb20-13" tabindex="-1"></a><span class="co">#&gt; 3    17.159893</span></span>
<span id="cb20-14"><a href="#cb20-14" tabindex="-1"></a><span class="co">#&gt; 4    54.350587</span></span>
<span id="cb20-15"><a href="#cb20-15" tabindex="-1"></a><span class="co">#&gt; 5    67.699017</span></span></code></pre></div>
<p>This model with random arrivals and exponential service times is an
example of an M/M/1 queue and could rather easily be solved analytically
to calculate the steady-state mean waiting time and other operating
characteristics. (But not so easily solved for its transient
behavior.)</p>
</div>
</div>
<div id="several-service-counters" class="section level2">
<h2>Several Service Counters</h2>
<p>When we introduce several counters we must decide on a queue
discipline. Are customers going to make one queue or are they going to
form separate queues in front of each counter? Then there are
complications - will they be allowed to switch lines (jockey)? We first
consider a single queue with several counters and later consider
separate isolated queues. We will not look at jockeying.</p>
<div id="several-counters-but-a-single-queue" class="section level3">
<h3>Several Counters but a Single Queue</h3>
<p>Here we model a bank whose customers arrive randomly and are to be
served at a group of counters, taking a random time for service, where
we assume that waiting customers form a single first-in first-out
queue.</p>
<p>The only difference between this model and the single-server model is
in the <code>add_resource</code> function, where we have increased the
capacity to two so that it can serve two customers at once.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1269</span>)</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a></span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="st">&quot;start_time&quot;</span>, <span class="cf">function</span>() {<span class="fu">now</span>(bank)}) <span class="sc">%&gt;%</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>  <span class="fu">seize</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Waited: &quot;</span>, <span class="fu">now</span>(bank) <span class="sc">-</span> <span class="fu">get_attribute</span>(bank, <span class="st">&quot;start_time&quot;</span>))}) <span class="sc">%&gt;%</span></span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="cf">function</span>() {<span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>)}) <span class="sc">%&gt;%</span></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>  <span class="fu">release</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Finished: &quot;</span>, <span class="fu">now</span>(bank))})</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>  <span class="fu">add_resource</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span> <span class="co"># Here is the change</span></span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="cf">function</span>() {<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>), <span class="sc">-</span><span class="dv">1</span>)})</span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a></span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Here I am</span></span>
<span id="cb21-22"><a href="#cb21-22" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Waited:  0</span></span>
<span id="cb21-23"><a href="#cb21-23" tabindex="-1"></a><span class="co">#&gt; 3.68365: Customer1: Here I am</span></span>
<span id="cb21-24"><a href="#cb21-24" tabindex="-1"></a><span class="co">#&gt; 3.68365: Customer1: Waited:  0</span></span>
<span id="cb21-25"><a href="#cb21-25" tabindex="-1"></a><span class="co">#&gt; 3.89529: Customer2: Here I am</span></span>
<span id="cb21-26"><a href="#cb21-26" tabindex="-1"></a><span class="co">#&gt; 4.91521: Customer0: Finished:  4.91521483175031</span></span>
<span id="cb21-27"><a href="#cb21-27" tabindex="-1"></a><span class="co">#&gt; 4.91521: Customer2: Waited:  1.01992474790691</span></span>
<span id="cb21-28"><a href="#cb21-28" tabindex="-1"></a><span class="co">#&gt; 10.961: Customer3: Here I am</span></span>
<span id="cb21-29"><a href="#cb21-29" tabindex="-1"></a><span class="co">#&gt; 12.4143: Customer4: Here I am</span></span>
<span id="cb21-30"><a href="#cb21-30" tabindex="-1"></a><span class="co">#&gt; 19.8236: Customer1: Finished:  19.8236157265107</span></span>
<span id="cb21-31"><a href="#cb21-31" tabindex="-1"></a><span class="co">#&gt; 19.8236: Customer3: Waited:  8.86265226572255</span></span>
<span id="cb21-32"><a href="#cb21-32" tabindex="-1"></a><span class="co">#&gt; 34.6254: Customer3: Finished:  34.6254194662285</span></span>
<span id="cb21-33"><a href="#cb21-33" tabindex="-1"></a><span class="co">#&gt; 34.6254: Customer4: Waited:  22.2110816140186</span></span>
<span id="cb21-34"><a href="#cb21-34" tabindex="-1"></a><span class="co">#&gt; 48.2406: Customer4: Finished:  48.2406153584756</span></span>
<span id="cb21-35"><a href="#cb21-35" tabindex="-1"></a><span class="co">#&gt; 49.1716: Customer2: Finished:  49.1715828181142</span></span>
<span id="cb21-36"><a href="#cb21-36" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 49.1715828181142 | next: </span></span>
<span id="cb21-37"><a href="#cb21-37" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb21-38"><a href="#cb21-38" tabindex="-1"></a><span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(2) | queue status: 0(Inf) }</span></span>
<span id="cb21-39"><a href="#cb21-39" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 5 }</span></span></code></pre></div>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  <span class="fu">get_mon_arrivals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>  <span class="fu">transform</span>(<span class="at">waiting_time =</span> end_time <span class="sc">-</span> start_time <span class="sc">-</span> activity_time)</span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a><span class="co">#&gt;        name start_time  end_time activity_time finished replication</span></span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a><span class="co">#&gt; 1 Customer0   0.000000  4.915215      4.915215     TRUE           1</span></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a><span class="co">#&gt; 2 Customer1   3.683648 19.823616     16.139968     TRUE           1</span></span>
<span id="cb22-7"><a href="#cb22-7" tabindex="-1"></a><span class="co">#&gt; 3 Customer3  10.960963 34.625419     14.801804     TRUE           1</span></span>
<span id="cb22-8"><a href="#cb22-8" tabindex="-1"></a><span class="co">#&gt; 4 Customer4  12.414338 48.240615     13.615196     TRUE           1</span></span>
<span id="cb22-9"><a href="#cb22-9" tabindex="-1"></a><span class="co">#&gt; 5 Customer2   3.895290 49.171583     44.256368     TRUE           1</span></span>
<span id="cb22-10"><a href="#cb22-10" tabindex="-1"></a><span class="co">#&gt;   waiting_time</span></span>
<span id="cb22-11"><a href="#cb22-11" tabindex="-1"></a><span class="co">#&gt; 1     0.000000</span></span>
<span id="cb22-12"><a href="#cb22-12" tabindex="-1"></a><span class="co">#&gt; 2     0.000000</span></span>
<span id="cb22-13"><a href="#cb22-13" tabindex="-1"></a><span class="co">#&gt; 3     8.862652</span></span>
<span id="cb22-14"><a href="#cb22-14" tabindex="-1"></a><span class="co">#&gt; 4    22.211082</span></span>
<span id="cb22-15"><a href="#cb22-15" tabindex="-1"></a><span class="co">#&gt; 5     1.019925</span></span></code></pre></div>
<p>The waiting times in this model are much shorter than those for the
single service counter. For example, the waiting time for Customer3 has
been reduced from nearly 17 minutes to less than 9. Again we have too
few customers processed to draw general conclusions.</p>
</div>
<div id="several-counters-with-individual-queues" class="section level3">
<h3>Several Counters with individual queues</h3>
<p>Each counter is now assumed to have its own queue. The programming is
more complicated because the customer has to decide which queue to join.
The obvious technique is to make each counter a separate resource.</p>
<p>In practice, a customer might join the shortest queue. We implement
this behaviour by first selecting the shortest queue, using the
<code>select</code> function. Then we use <code>seize_selected</code> to
enter the chosen queue, and later <code>release_selected</code>.</p>
<p>The rest of the program is the same as before.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a></span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">1014</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a></span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb23-6"><a href="#cb23-6" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-7"><a href="#cb23-7" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="st">&quot;Here I am&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-8"><a href="#cb23-8" tabindex="-1"></a>  <span class="fu">set_attribute</span>(<span class="st">&quot;start_time&quot;</span>, <span class="cf">function</span>() {<span class="fu">now</span>(bank)}) <span class="sc">%&gt;%</span></span>
<span id="cb23-9"><a href="#cb23-9" tabindex="-1"></a>  <span class="fu">select</span>(<span class="fu">c</span>(<span class="st">&quot;counter1&quot;</span>, <span class="st">&quot;counter2&quot;</span>), <span class="at">policy =</span> <span class="st">&quot;shortest-queue&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-10"><a href="#cb23-10" tabindex="-1"></a>  <span class="fu">seize_selected</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-11"><a href="#cb23-11" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Waited: &quot;</span>, <span class="fu">now</span>(bank) <span class="sc">-</span> <span class="fu">get_attribute</span>(bank, <span class="st">&quot;start_time&quot;</span>))}) <span class="sc">%&gt;%</span></span>
<span id="cb23-12"><a href="#cb23-12" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="cf">function</span>() {<span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>)}) <span class="sc">%&gt;%</span></span>
<span id="cb23-13"><a href="#cb23-13" tabindex="-1"></a>  <span class="fu">release_selected</span>() <span class="sc">%&gt;%</span></span>
<span id="cb23-14"><a href="#cb23-14" tabindex="-1"></a>  <span class="fu">log_</span>(<span class="cf">function</span>() {<span class="fu">paste</span>(<span class="st">&quot;Finished: &quot;</span>, <span class="fu">now</span>(bank))})</span>
<span id="cb23-15"><a href="#cb23-15" tabindex="-1"></a></span>
<span id="cb23-16"><a href="#cb23-16" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb23-17"><a href="#cb23-17" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-18"><a href="#cb23-18" tabindex="-1"></a>  <span class="fu">add_resource</span>(<span class="st">&quot;counter1&quot;</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-19"><a href="#cb23-19" tabindex="-1"></a>  <span class="fu">add_resource</span>(<span class="st">&quot;counter2&quot;</span>, <span class="dv">1</span>) <span class="sc">%&gt;%</span></span>
<span id="cb23-20"><a href="#cb23-20" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="cf">function</span>() {<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rexp</span>(<span class="dv">4</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>), <span class="sc">-</span><span class="dv">1</span>)})</span>
<span id="cb23-21"><a href="#cb23-21" tabindex="-1"></a></span>
<span id="cb23-22"><a href="#cb23-22" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb23-23"><a href="#cb23-23" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Here I am</span></span>
<span id="cb23-24"><a href="#cb23-24" tabindex="-1"></a><span class="co">#&gt; 0: Customer0: Waited:  0</span></span>
<span id="cb23-25"><a href="#cb23-25" tabindex="-1"></a><span class="co">#&gt; 23.7144: Customer1: Here I am</span></span>
<span id="cb23-26"><a href="#cb23-26" tabindex="-1"></a><span class="co">#&gt; 23.7144: Customer1: Waited:  0</span></span>
<span id="cb23-27"><a href="#cb23-27" tabindex="-1"></a><span class="co">#&gt; 30.4011: Customer2: Here I am</span></span>
<span id="cb23-28"><a href="#cb23-28" tabindex="-1"></a><span class="co">#&gt; 32.4163: Customer3: Here I am</span></span>
<span id="cb23-29"><a href="#cb23-29" tabindex="-1"></a><span class="co">#&gt; 33.941: Customer1: Finished:  33.94103133502</span></span>
<span id="cb23-30"><a href="#cb23-30" tabindex="-1"></a><span class="co">#&gt; 33.941: Customer3: Waited:  1.52471543798104</span></span>
<span id="cb23-31"><a href="#cb23-31" tabindex="-1"></a><span class="co">#&gt; 39.5302: Customer3: Finished:  39.5301990230619</span></span>
<span id="cb23-32"><a href="#cb23-32" tabindex="-1"></a><span class="co">#&gt; 48.8559: Customer4: Here I am</span></span>
<span id="cb23-33"><a href="#cb23-33" tabindex="-1"></a><span class="co">#&gt; 48.8559: Customer4: Waited:  0</span></span>
<span id="cb23-34"><a href="#cb23-34" tabindex="-1"></a><span class="co">#&gt; 55.3965: Customer4: Finished:  55.3964510986066</span></span>
<span id="cb23-35"><a href="#cb23-35" tabindex="-1"></a><span class="co">#&gt; 62.1037: Customer0: Finished:  62.1037152193123</span></span>
<span id="cb23-36"><a href="#cb23-36" tabindex="-1"></a><span class="co">#&gt; 62.1037: Customer2: Waited:  31.7026170465295</span></span>
<span id="cb23-37"><a href="#cb23-37" tabindex="-1"></a><span class="co">#&gt; 62.3885: Customer2: Finished:  62.3885266177193</span></span>
<span id="cb23-38"><a href="#cb23-38" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 62.3885266177193 | next: </span></span>
<span id="cb23-39"><a href="#cb23-39" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb23-40"><a href="#cb23-40" tabindex="-1"></a><span class="co">#&gt; { Resource: counter1 | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span></span>
<span id="cb23-41"><a href="#cb23-41" tabindex="-1"></a><span class="co">#&gt; { Resource: counter2 | monitored: TRUE | server status: 0(1) | queue status: 0(Inf) }</span></span>
<span id="cb23-42"><a href="#cb23-42" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 5 }</span></span></code></pre></div>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>  <span class="fu">get_mon_arrivals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a>  <span class="fu">transform</span>(<span class="at">service_start_time =</span> end_time <span class="sc">-</span> activity_time) <span class="sc">%&gt;%</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a>  .[<span class="fu">order</span>(.<span class="sc">$</span>start_time),]</span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="co">#&gt;        name start_time end_time activity_time finished replication</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="co">#&gt; 4 Customer0    0.00000 62.10372    62.1037152     TRUE           1</span></span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a><span class="co">#&gt; 1 Customer1   23.71444 33.94103    10.2265939     TRUE           1</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a><span class="co">#&gt; 5 Customer2   30.40110 62.38853     0.2848114     TRUE           1</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a><span class="co">#&gt; 2 Customer3   32.41632 39.53020     5.5891677     TRUE           1</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a><span class="co">#&gt; 3 Customer4   48.85593 55.39645     6.5405163     TRUE           1</span></span>
<span id="cb24-11"><a href="#cb24-11" tabindex="-1"></a><span class="co">#&gt;   service_start_time</span></span>
<span id="cb24-12"><a href="#cb24-12" tabindex="-1"></a><span class="co">#&gt; 4            0.00000</span></span>
<span id="cb24-13"><a href="#cb24-13" tabindex="-1"></a><span class="co">#&gt; 1           23.71444</span></span>
<span id="cb24-14"><a href="#cb24-14" tabindex="-1"></a><span class="co">#&gt; 5           62.10372</span></span>
<span id="cb24-15"><a href="#cb24-15" tabindex="-1"></a><span class="co">#&gt; 2           33.94103</span></span>
<span id="cb24-16"><a href="#cb24-16" tabindex="-1"></a><span class="co">#&gt; 3           48.85593</span></span></code></pre></div>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>bank <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>  <span class="fu">get_mon_resources</span>() <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>  .[<span class="fu">order</span>(.<span class="sc">$</span>time),]</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="co">#&gt;    resource     time server queue capacity queue_size system limit replication</span></span>
<span id="cb25-5"><a href="#cb25-5" tabindex="-1"></a><span class="co">#&gt; 1  counter1  0.00000      1     0        1        Inf      1   Inf           1</span></span>
<span id="cb25-6"><a href="#cb25-6" tabindex="-1"></a><span class="co">#&gt; 2  counter2 23.71444      1     0        1        Inf      1   Inf           1</span></span>
<span id="cb25-7"><a href="#cb25-7" tabindex="-1"></a><span class="co">#&gt; 3  counter1 30.40110      1     1        1        Inf      2   Inf           1</span></span>
<span id="cb25-8"><a href="#cb25-8" tabindex="-1"></a><span class="co">#&gt; 4  counter2 32.41632      1     1        1        Inf      2   Inf           1</span></span>
<span id="cb25-9"><a href="#cb25-9" tabindex="-1"></a><span class="co">#&gt; 5  counter2 33.94103      1     0        1        Inf      1   Inf           1</span></span>
<span id="cb25-10"><a href="#cb25-10" tabindex="-1"></a><span class="co">#&gt; 6  counter2 39.53020      0     0        1        Inf      0   Inf           1</span></span>
<span id="cb25-11"><a href="#cb25-11" tabindex="-1"></a><span class="co">#&gt; 7  counter2 48.85593      1     0        1        Inf      1   Inf           1</span></span>
<span id="cb25-12"><a href="#cb25-12" tabindex="-1"></a><span class="co">#&gt; 8  counter2 55.39645      0     0        1        Inf      0   Inf           1</span></span>
<span id="cb25-13"><a href="#cb25-13" tabindex="-1"></a><span class="co">#&gt; 9  counter1 62.10372      1     0        1        Inf      1   Inf           1</span></span>
<span id="cb25-14"><a href="#cb25-14" tabindex="-1"></a><span class="co">#&gt; 10 counter1 62.38853      0     0        1        Inf      0   Inf           1</span></span></code></pre></div>
<p>The results show that the customers chose the counter with the
smallest number. Unlucky Customer2 who joins the wrong queue has to wait
until Customer0 finishes at time 62.10372, and is the last to leave.
There are, however, too few arrivals in these runs, limited as they are
to five customers, to draw any general conclusions about the relative
efficiencies of the two systems.</p>
</div>
<div id="the-bank-with-a-monitor-aka-summary-statistics" class="section level3">
<h3>The bank with a monitor (aka summary statistics)</h3>
<p>We now demonstrate how to calculate average waiting times for our
customers. In the original SimPy version of this tutorial, this involved
using ‘Monitors’. In simmer, data is returned by the
<code>get_mon_*</code> family of functions, as has already been
demonstrated. Here, we simply summarise the data frame returned by the
<code>get_mon_arrivals</code> function, using standard R functions.</p>
<p>We also increase the number of customers to 50 (find the number ‘49’
in the code).</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a></span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">100005</span>)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a></span>
<span id="cb26-5"><a href="#cb26-5" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb26-6"><a href="#cb26-6" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-7"><a href="#cb26-7" tabindex="-1"></a>  <span class="fu">seize</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-8"><a href="#cb26-8" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="cf">function</span>() {<span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>)}) <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" tabindex="-1"></a>  <span class="fu">release</span>(<span class="st">&quot;counter&quot;</span>)</span>
<span id="cb26-10"><a href="#cb26-10" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" tabindex="-1"></a>bank <span class="ot">&lt;-</span></span>
<span id="cb26-12"><a href="#cb26-12" tabindex="-1"></a>  <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-13"><a href="#cb26-13" tabindex="-1"></a>  <span class="fu">add_resource</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-14"><a href="#cb26-14" tabindex="-1"></a>  <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="cf">function</span>() {<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rexp</span>(<span class="dv">49</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>), <span class="sc">-</span><span class="dv">1</span>)})</span>
<span id="cb26-15"><a href="#cb26-15" tabindex="-1"></a></span>
<span id="cb26-16"><a href="#cb26-16" tabindex="-1"></a>bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">1000</span>)</span>
<span id="cb26-17"><a href="#cb26-17" tabindex="-1"></a><span class="co">#&gt; simmer environment: bank | now: 650.615510598544 | next: </span></span>
<span id="cb26-18"><a href="#cb26-18" tabindex="-1"></a><span class="co">#&gt; { Monitor: in memory }</span></span>
<span id="cb26-19"><a href="#cb26-19" tabindex="-1"></a><span class="co">#&gt; { Resource: counter | monitored: TRUE | server status: 0(2) | queue status: 0(Inf) }</span></span>
<span id="cb26-20"><a href="#cb26-20" tabindex="-1"></a><span class="co">#&gt; { Source: Customer | monitored: 1 | n_generated: 50 }</span></span></code></pre></div>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a></span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>result <span class="ot">&lt;-</span></span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>  bank <span class="sc">%&gt;%</span></span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>  <span class="fu">get_mon_arrivals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a>  <span class="fu">transform</span>(<span class="at">waiting_time =</span> end_time <span class="sc">-</span> start_time <span class="sc">-</span> activity_time)</span></code></pre></div>
<p>The average waiting time for 50 customers in this 2-counter system is
more reliable (i.e., less subject to random simulation effects) than the
times we measured before but it is still not sufficiently reliable for
real-world decisions. We should also replicate the runs using different
random number seeds. The result of this run is:</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">paste</span>(<span class="st">&quot;Average wait for &quot;</span>, <span class="fu">sum</span>(result<span class="sc">$</span>finished), <span class="st">&quot; completions was &quot;</span>,</span>
<span id="cb28-2"><a href="#cb28-2" tabindex="-1"></a>      <span class="fu">mean</span>(result<span class="sc">$</span>waiting_time), <span class="st">&quot;minutes.&quot;</span>)</span>
<span id="cb28-3"><a href="#cb28-3" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Average wait for  50  completions was  3.05085138406832 minutes.&quot;</span></span></code></pre></div>
</div>
<div id="multiple-runs" class="section level3">
<h3>Multiple runs</h3>
<p>To get a number of independent measurements we must replicate the
runs using different random number seeds. Each replication must be
independent of previous ones, so the environment (bank) must be
redefined for each run, so that the random interarrival times in the
<code>add_generator</code> function are generated from scratch.</p>
<p>We take the chunks of code that build the environment (bank) and run
the simulation, and wrap them in the <code>mclapply</code> function from
the ‘parallel’ package. This function runs each simulation in parallel,
using the available cores in the computer’s processor. Because we use
seeds for reproducability, we pass these to the function that runs the
simulation (<code>function(the_seed)</code>).</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="fu">library</span>(simmer)</span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a><span class="fu">library</span>(parallel)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>customer <span class="ot">&lt;-</span></span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>  <span class="fu">trajectory</span>(<span class="st">&quot;Customer&#39;s path&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a>  <span class="fu">seize</span>(<span class="st">&quot;counter&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-7"><a href="#cb29-7" tabindex="-1"></a>  <span class="fu">timeout</span>(<span class="cf">function</span>() {<span class="fu">rexp</span>(<span class="dv">1</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>)}) <span class="sc">%&gt;%</span></span>
<span id="cb29-8"><a href="#cb29-8" tabindex="-1"></a>  <span class="fu">release</span>(<span class="st">&quot;counter&quot;</span>)</span>
<span id="cb29-9"><a href="#cb29-9" tabindex="-1"></a></span>
<span id="cb29-10"><a href="#cb29-10" tabindex="-1"></a><span class="fu">mclapply</span>(<span class="fu">c</span>(<span class="dv">393943</span>, <span class="dv">100005</span>, <span class="dv">777999555</span>, <span class="dv">319999772</span>), <span class="cf">function</span>(the_seed) {</span>
<span id="cb29-11"><a href="#cb29-11" tabindex="-1"></a>  <span class="fu">set.seed</span>(the_seed)</span>
<span id="cb29-12"><a href="#cb29-12" tabindex="-1"></a></span>
<span id="cb29-13"><a href="#cb29-13" tabindex="-1"></a>  bank <span class="ot">&lt;-</span></span>
<span id="cb29-14"><a href="#cb29-14" tabindex="-1"></a>    <span class="fu">simmer</span>(<span class="st">&quot;bank&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-15"><a href="#cb29-15" tabindex="-1"></a>    <span class="fu">add_resource</span>(<span class="st">&quot;counter&quot;</span>, <span class="dv">2</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-16"><a href="#cb29-16" tabindex="-1"></a>    <span class="fu">add_generator</span>(<span class="st">&quot;Customer&quot;</span>, customer, <span class="cf">function</span>() {<span class="fu">c</span>(<span class="dv">0</span>, <span class="fu">rexp</span>(<span class="dv">49</span>, <span class="dv">1</span><span class="sc">/</span><span class="dv">10</span>), <span class="sc">-</span><span class="dv">1</span>)})</span>
<span id="cb29-17"><a href="#cb29-17" tabindex="-1"></a></span>
<span id="cb29-18"><a href="#cb29-18" tabindex="-1"></a>  bank <span class="sc">%&gt;%</span> <span class="fu">run</span>(<span class="at">until =</span> <span class="dv">400</span>)</span>
<span id="cb29-19"><a href="#cb29-19" tabindex="-1"></a>  result <span class="ot">&lt;-</span></span>
<span id="cb29-20"><a href="#cb29-20" tabindex="-1"></a>    bank <span class="sc">%&gt;%</span></span>
<span id="cb29-21"><a href="#cb29-21" tabindex="-1"></a>    <span class="fu">get_mon_arrivals</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-22"><a href="#cb29-22" tabindex="-1"></a>    <span class="fu">transform</span>(<span class="at">waiting_time =</span> end_time <span class="sc">-</span> start_time <span class="sc">-</span> activity_time)</span>
<span id="cb29-23"><a href="#cb29-23" tabindex="-1"></a>  <span class="fu">paste</span>(<span class="st">&quot;Average wait for &quot;</span>, <span class="fu">sum</span>(result<span class="sc">$</span>finished), <span class="st">&quot; completions was &quot;</span>,</span>
<span id="cb29-24"><a href="#cb29-24" tabindex="-1"></a>        <span class="fu">mean</span>(result<span class="sc">$</span>waiting_time), <span class="st">&quot;minutes.&quot;</span>)</span>
<span id="cb29-25"><a href="#cb29-25" tabindex="-1"></a>}) <span class="sc">%&gt;%</span> <span class="fu">unlist</span>()</span>
<span id="cb29-26"><a href="#cb29-26" tabindex="-1"></a><span class="co">#&gt; [1] &quot;Average wait for  49  completions was  3.4958501806687 minutes.&quot;  </span></span>
<span id="cb29-27"><a href="#cb29-27" tabindex="-1"></a><span class="co">#&gt; [2] &quot;Average wait for  29  completions was  0.584941574937737 minutes.&quot;</span></span>
<span id="cb29-28"><a href="#cb29-28" tabindex="-1"></a><span class="co">#&gt; [3] &quot;Average wait for  32  completions was  1.00343842138177 minutes.&quot; </span></span>
<span id="cb29-29"><a href="#cb29-29" tabindex="-1"></a><span class="co">#&gt; [4] &quot;Average wait for  42  completions was  7.41231393636088 minutes.&quot;</span></span></code></pre></div>
<p>The results show some variation. Remember, though, that the system is
still only operating for 50 customers, so the system may not be in
steady-state.</p>
</div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
